import{visit as e}from"unist-util-visit";import t from"cross-fetch";import{fromDom as n}from"hast-util-from-dom";function i(){return i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},i.apply(this,arguments)}const r=/\[([^[\]]*@[^[\]]+)\]|(?!\b)(@[a-zA-Z0-9_][a-zA-Z0-9_:.#$%&\-+?<>~]*)/,o=/@([a-zA-Z0-9_][a-zA-Z0-9_:.#$%&\-+?<>~]*)/,s=/\[.*\]/,a={book:"book","bk.":"book","bks.":"book",chapter:"chapter","chap.":"chapter","chaps.":"chapter",column:"column","col.":"column","cols.":"column",figure:"figure","fig.":"figure","figs.":"figure",folio:"folio","fol.":"folio","fols.":"folio",number:"number","no.":"number","nos.":"number",line:"line","l.":"line","ll.":"line",note:"note","n.":"note","nn.":"note",opus:"opus","op.":"opus","opp.":"opus",page:"page","p.":"page","pp.":"page",paragraph:"paragraph","para.":"paragraph","paras.":"paragraph",part:"part","pt.":"part","pts.":"part",section:"section","sec.":"section","secs.":"section","sub verbo":"sub verbo","s.v.":"sub verbo","s.vv.":"sub verbo",verse:"verse","v.":"verse","vv.":"verse",volume:"volume","vol.":"volume","vols.":"volume","¶":"paragraph","¶¶":"paragraph","§":"section","§§":"section"},l=async e=>{if(p(e))return t(e).then(e=>e.text()).then(e=>e);throw new Error("Cannot read non valid URL in node env.")},p=e=>{let t;try{t=new URL(e)}catch(e){return!1}return"http:"===t.protocol||"https:"===t.protocol},c=e=>{const t=document.createRange().createContextualFragment(e);return n(t).children[0]},u=["div","p","span","li"],d=n=>(d={})=>async(h,f)=>{var m,g,b;let v,y=await(async(e,t)=>{var n,i;let r="";if(e.bibliography)r=e.bibliography;else if(null!=t&&null!=(n=t.data)&&null!=(i=n.frontmatter)&&i.bibliography&&(r=t.data.frontmatter.bibliography,!p(r)))throw new Error("Cannot read non valid bibliography URL in node env.");return r})(d,f);if(!y)return;const w=d.csl||(null==f||null==(m=f.data)||null==(g=m.frontmatter)?void 0:g.csl)||"apa",$=d.lang||"en-US",x=n.plugins.config.get("@csl"),N=await(async(e,t,n="")=>{const i=e.plugins.config.get("@csl");if(Object.keys(i.templates.data).includes(t))return t;{const e=`customCSL-${Math.random().toString(36).slice(2,7)}`;let n="";p(t)&&(n=t);try{i.templates.add(e,await l(n))}catch(e){throw new Error(`Input CSL option, ${t}, is invalid or is an unknown file.`)}return e}})(n,w,d.path),C=await(async(e,t,n="")=>{const i=e.plugins.config.get("@csl");if(Object.keys(i.locales.data).includes(t))return t;{let e="";p(t)&&(e=t);try{const t=await l(e),n=t.match(/xml:lang="(.+)"/)[1];return i.locales.add(n,t),n}catch(e){throw new Error(`Input locale option, ${t}, is invalid or is an unknown file.`)}}})(n,$,d.path);if(!p(y))throw new Error("Cannot read non valid bibliography URL in node env.");{const e=await t(y);v=await e.text()}const k=new n(v),I=k.data.map(e=>e.id),O=[],j={};let B=1;const E=x.engine(k.data,N,C,"html"),L=E.opt.xclass;if(e(h,"text",(e,t,n)=>{const i=e.value.match(r);if(!i||!u.includes(n.tagName))return;const l=i.index,p=i.index+i[0].length,h=[];0!==l&&h.push({type:"text",value:e.value.slice(0,l)});const[f,m]=(e=>{let t=[],n=!1;if(s.test(e)){const n=e.substr(1,e.length-2).split(";");for(const e of n){let n="",i="",r="page",s="";const l=e.split("@");if(1===l.length)throw new Error("Cite key should be in the form of @key");if(l.length>2)throw new Error("More than one cite key @ detected, please separate keys with ;");n+=l[0],n=n.trim();let p=e.indexOf("@")>0&&"-"===e[e.indexOf("@")-1];p&&(n=n.substr(0,n.length-1).trim());let c=l[1].indexOf(",")+1;0===c&&(c=l[1].indexOf(" ")+1),c<=0&&(c=void 0);const u=e.substr(e.indexOf("@"),c).match(o)[0];let d=e.split("@")[1].substr(u.length).trim();","===d[0]&&(d=d.substr(1).trim());const h=d.match(/(\d|-| |,)+/g);null!==h?(i=h[0].trim(),r=d.split(i)[0].trim(),r=a[r]||"page",s=d.split(i)[1].trim()):s=d.trim(),t.push({id:e.match(o)[1],locator:i,label:r,prefix:n,suffix:s,"suppress-author":p})}}else n=!0,t=[e].map(e=>({id:e.match(o)[1]}));return[t,n]})(i[0]);for(const e of f)if(!I.includes(e.id))return;const[g,b]=((e,t,n,i,r,o,s)=>{var a;const l=`CITATION-${i}`,p=e.processCitationCluster({citationID:l,citationItems:n,properties:"in-text"===t?{noteIndex:0,mode:s?"composite":""}:{noteIndex:i,mode:s?"composite":""}},r.length>0?r:[],[])[1].find(e=>e[2]===l)[1],u=`citation--${n.map(e=>e.id.toLowerCase()).join("--")}--${i}`;var d;return"note"===t?[p,c(`<span class="${(null!=(d=o.inlineClass)?d:[]).join(" ")}" id=${u}><sup><a href="#cite-fn-${i}" id="cite-fnref-${i}" data-footnote-ref aria-describedby="footnote-label">${i}</a></sup></span>`)]:[p,c(`<span class="${(null!=(a=o.inlineClass)?a:[]).join(" ")}" id=${u}>${p}</span>`)]})(E,L,f,B,O,d,m);j[B]=g,O.push([`CITATION-${B}`,0]),B+=1,h.push(b),p<e.value.length&&h.push({type:"text",value:e.value.slice(p)}),n.children=[...n.children.slice(0,t),...h,...n.children.slice(t+1)]}),d.noCite&&E.updateItems(d.noCite.map(e=>e.replace("@",""))),E.registry.mylist.length>=1&&(!d.suppressBibliography||(null==(b=d.inlineBibClass)?void 0:b.length)>0)){const t=(e=>{const[t,n]=e.makeBibliography(),i='<div id="refs" class="references csl-bib-body">\n'+n.join("")+"</div>",r=c(i);return r.children.filter(e=>{var t,n;return null==(t=e.properties)||null==(n=t.className)?void 0:n.includes("csl-entry")}).forEach((e,n)=>{const i=t.entry_ids[n][0].toLowerCase();e.properties=e.properties||{},e.properties.id="bib-"+i}),r})(E);let n=!1;const r={};t.children.filter(e=>{var t,n;return null==(t=e.properties)||null==(n=t.className)?void 0:n.includes("csl-entry")}).forEach(e=>{const t=e.properties.id.split("-").slice(1).join("-");r[t]=i({},e),r[t].properties={id:"inlinebib-"+t}}),e(h,"element",(e,i,o)=>{var s,a,l;if((null==(s=d.inlineBibClass)?void 0:s.length)>0&&null!=(a=e.properties)&&null!=(l=a.id)&&l.toString().startsWith("citation-")){const[,...t]=e.properties.id.toString().split("--"),n=t.pop(),i={type:"element",tagName:"div",properties:{className:d.inlineBibClass,id:`inlineBib--${t.join("--")}--${n}`},children:t.map(e=>{const t=r[e];return t.properties={class:"inline-entry",id:`inline--${e}--${n}`},t})};o.children.push(i)}d.suppressBibliography||"p"!==e.tagName&&"div"!==e.tagName||"[^ref]"!==e.children[0].value||(o.children[i]=t,n=!0)}),d.suppressBibliography||n||h.children.push(t)}let S;if(e(h,"element",(e,t,n)=>{"section"===e.tagName&&e.properties.dataFootnotes&&(S=e,n.children.splice(t,1))}),"note"===L&&Object.keys(j).length>0){let t=[],n=1;e(h,"element",e=>{if("sup"===e.tagName){let i=e.children[0];if("a"===i.tagName){const{href:e,id:r}=i.properties;if(e.includes("fn")&&r.includes("fnref")){const r=e.split("-").pop();t.push({type:e.includes("cite")?"citation":"existing",oldId:r}),i.properties.href=`#user-content-fn-${n}`,i.properties.id=`user-content-fnref-${n}`,i.children[0].value=n.toString(),n+=1}}}});const i=((e,t,n)=>{const i={type:"element",tagName:"ol",children:[{type:"text",value:"\n"}]};let r;n&&(r=n.children.find(e=>"ol"===e.tagName));for(const[n,o]of t.entries()){const{type:t,oldId:s}=o;if("citation"===t)i.children.push({type:"element",tagName:"li",properties:{id:`user-content-fn-${n+1}`},children:[{type:"element",tagName:"p",properties:{},children:[c(`<span>${e[s]}</span>`),{type:"element",tagName:"a",properties:{href:`#user-content-fnref-${n+1}`,dataFootnoteBackref:!0,className:["data-footnote-backref"],ariaLabel:"Back to content"},children:[{type:"text",value:"↩"}]}]},{type:"text",value:"\n"}]});else if("existing"===t){const e=r.children.find(e=>"li"===e.tagName&&e.properties.id===`user-content-fn-${s}`);e.properties.id=`user-content-fn-${n+1}`,e.children[1].children.find(e=>"a"===e.tagName).properties.href=`#user-content-fnref-${n+1}`,i.children.push(e)}}return{type:"element",tagName:"section",properties:{dataFootnotes:!0,className:["footnotes"]},children:[{type:"element",tagName:"h2",properties:{className:["sr-only"],id:"footnote-label"},children:[{type:"text",value:"Footnotes"}]},{type:"text",value:"\n"},i]}})(j,t,S);h.children.push(i)}else S&&h.children.push(S)};export{d as default};
//# sourceMappingURL=generator.mjs.map
